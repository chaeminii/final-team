<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.doublecome.repository.mapper.ChattingMapper">
	<select id="listChat" parameterType="String" resultType="Chat">
		select 		c.chat_no,
		    c.deal_no,
		    c.user_email_seller,
		    c.user_email_buyer,
		    c.reads_seller,
		    c.reads_buyer,
		    b.covst_content,
		    b.covst_reg_date,
            d.auction_title,
		    (select file_group_Code
			   from user
			  where user_email = c.user_email_seller
		    ) as sellerFileGroupCode,
		    (select file_group_Code
			   from user
			  where user_email = c.user_email_buyer
		    ) as buyerFileGroupCode,
		      (select user_nickname
			   from user
			  where user_email = c.user_email_seller
		    ) as sellerNickName, 
		    (select user_nickname
			   from user
			  where user_email = c.user_email_buyer
		    ) as buyerNickName
		  from chat c 
		 left join (select covst_content, covst_reg_date, chat_no
		               from conversation
					  order by covst_no desc
		              limit 1) as b
		    on c.chat_no = b.chat_no
		  inner join (select deal_no, del.auction_no, auction_title
						from deal del
					   inner join auction auc
						on del.auction_no = auc.auction_no) as d
				on d.deal_no = c.deal_no
		  where  user_email_seller like #{email}
		     or user_email_buyer like #{email}
	</select>
	<select id="oneChat" parameterType="int" resultType="ConverSation">
		select 
			covst_no,
			covst_content,
			user_email,
			chat_no,
			covst_reg_date
		  from conversation
		 where chat_no = #{chatNo}
		 order by covst_no
	</select>
	<update id="updateChat" parameterType="ConverSation" >
		update chat
		   <choose>
		   <when test="userType == 1">
		   		set reads_seller = 0
		   </when>
		   <otherwise>
		   		set reads_buyer = 0
		   </otherwise>
		   </choose>
		 where chat_no = #{chatNo}
	</update>
	<insert id="addCovstData" parameterType="ConverSation">
		insert into conversation(covst_content, user_Email, chat_No)
		 values(#{covstContent},#{userEmail},#{chatNo})
	</insert>
</mapper>