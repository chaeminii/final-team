<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.doublecome.repository.mapper.AuctionMapper">
	<!--  카테고리 리스트 가져오기 -->
	<select id="categoryList" resultType="Category">
		select *
		  from category
	</select>
	<select id="listAuction" resultType="Auction" parameterType="SearchAuction">
		select distinct
			a.auction_no,
			a.auction_title,
			a.auction_reg_date,
			a.auction_limit_date,
			a.auction_min_price,
			a.auction_buy_now,
			a.auction_min_price,
			a.file_group_code,
			a.user_email,
            b.bid_cnt,
            b.max_price
	 	 from auction a 
	  	inner join(select auction_no,
	  					  IFNULL(max(bid_price) over(partition by auction_no),0) as max_price,
					  	  count(bid_no) over(partition by auction_no) as bid_cnt
					 from bid) b
		   on a.auction_no = b.auction_no
		where auction_condition = 1
	  	<if test="categoryCode != 0">
	  		and category_code = #{categoryCode}
	  	</if>
	  	<choose>
			<when test="endPrice == 0 and startPrice != 2">
				and max_price >= #{startPrice}
			</when>
			<when  test="endPrice == 0 and startPrice == 2">
				and 20000 >= max_price
			</when>	
			<otherwise>
				and max_price between ${startPrice} and #{endPrice}
			</otherwise>			
		</choose>
		order by bid_cnt desc
	</select>
</mapper>