<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="kr.co.doublecome.repository.mapper.AuctionDetailMapper">
	<!-- 옥션 해당페이지 retrieve -->
	<select id="auctiondetail" resultType="Auction" parameterType="int">
		select distinct a.*,
		count(b.auction_no) over(partition by b.auction_no) as bid_cnt,
		max(b.bid_price) over(partition by b.auction_no) as max_price
		from auction a
		left join bid b
		on a.auction_no = b.auction_no
		where a.auction_no = #{auctionNo}
	</select>
	
	<select id="retrieveinquiry" resultType="Inquiry" parameterType="Search">
			select i.*, u.user_nickname , 
            count(i.user_email) over() as inquiry_cnt
			from inquiry i
			inner join user u
			on i.user_email = u.user_email
			where auction_no = #{keyword}
			order by IF(ISNULL(inquiry_parent), inquiry_no, inquiry_parent) desc
			limit #{begin},#{listSize}
	</select>
	
	<insert id="insertInquiry" parameterType="Inquiry">
		insert into inquiry (inquiry_content, inquiry_parent, auction_no, user_email)
		values (#{inquiryContent}, 
		<if test="inquiryParent != 0">
		#{inquiryParent}
		</if>
		<if test="inquiryParent == 0">
		null
		</if>
		, #{auctionNo}, #{userEmail})
	</insert>
	
	<insert id="addAuction" parameterType="Auction">
		insert into auction (auction_title, auction_content, auction_limit_date, auction_buy_now, auction_min_price, user_email, file_group_code, category_code)
		values (#{auctionTitle}, #{auctionContent}, #{auctionLimitDate}, #{auctionBuyNow}, #{auctionMinPrice}, #{userEmail}, #{fileGroupCode}, #{categoryCode})
	</insert>
	
	<select id="maxFileGroupCode" resultType="int">
		select max(file_group_code)
		from file
	</select>
	
	<insert id="addFile" parameterType="UtilFile" >
		<selectKey order="AFTER" keyProperty="fileNo" keyColumn="file_no" resultType="int">
			select max(file_no)
			  from file
		</selectKey>
		insert into file (file_group_code, file_origin_name, file_system_name, file_path)
		values (#{fileGroupCode}, #{fileOriginName}, #{fileSystemName}, #{filePath})
	</insert>
	
	<select id="retrieveFile" parameterType="int" resultType="UtilFile">
		select *
		from file f
		inner join auction a
		on f.file_group_code = a.file_group_code
		where a.auction_no = #{auctionNo}
	</select>
	
	<delete id="deleteAuction" parameterType="int">
		delete
		from auction
		where auction_no = #{auctionNo}
	</delete>
	
	<update id="updateInquiry" parameterType="Inquiry">
		update inquiry
		set inquiry_content = #{inquiryContent}
		where inquiry_no = #{inquiryNo}
	</update>
	
	<delete id="deleteInquiry" parameterType="int">
		delete
		from inquiry
		where inquiry_no = #{inquiryNo}
		or inquiry_parent = #{inquiryNo}
	</delete>

	<insert id="auctionBid" parameterType="Auction">
		insert into bid(bid_price, user_email, auction_no)
		values(#{bidPrice}, #{userEmail}, #{auctionNo})
	</insert>
	
	<insert id="insertDeal" parameterType="Deal">
		insert into deal(auction_no, user_email_buyer, user_email_seller)
		values (#{auctionNo}, #{userEmailBuyer}, #{userEmailSeller});
	</insert>
	
	<!-- 
	insert into deal (auction_no, user_email_buyer, user_email_seller) 
select a.auction_no,  b.user_email as user_email_buyer, a.user_email as user_email_seller   
from bid b   
join auction a     
on a.auction_no = b.auction_no     
where a.auction_limit_date = now()   
group by b.auction_no;


select a.auction_no,  b.user_email as user_email_buyer, a.user_email as user_email_seller, max(b.bid_price)
from bid b   
right join auction a     
on a.auction_no = b.auction_no     
where a.auction_limit_date = '2019-11-21 14:53:00'
group by b.auction_no
	 -->
	
	
</mapper>